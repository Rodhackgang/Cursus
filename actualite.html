<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Cursus - Formation pour Concours Directs, Scolaires et Professionnels</title>

    <!-- SEO Meta Tags -->
    <meta name="description"
        content="Cursus offre des formations spécialisées pour réussir les concours directs, scolaires et professionnels.">
    <meta name="keywords"
        content="Cursus, formation concours, formation scolaire, formation professionnelle, réussite concours">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://www.cursusbf.com">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Cursus - Formation pour Concours Directs, Scolaires et Professionnels">
    <meta property="og:description"
        content="Cursus offre des formations spécialisées pour réussir les concours directs, scolaires et professionnels.">
    <meta property="og:image" content="https://www.cursusbf.com/assets/img/logo.jpg">
    <meta property="og:url" content="https://www.cursusbf.com">
    <meta property="og:type" content="website">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Cursus - Formation pour Concours Directs, Scolaires et Professionnels">
    <meta name="twitter:description"
        content="Cursus offre des formations spécialisées pour réussir les concours directs, scolaires et professionnels.">
    <meta name="twitter:image" content="https://www.cursusbf.com/assets/img/logo.jpg">

    <!-- Schema.org Data -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Course",
      "name": "Formation pour Concours Directs, Scolaires et Professionnels",
      "description": "Cursus offre des formations spécialisées pour réussir les concours directs, scolaires et professionnels.",
      "provider": {
        "@type": "Organization",
        "name": "Cursus"
      },
      "educationalCredentialAwarded": "Certificat de réussite",
      "url": "https://www.cursusbf.com"
    }
    </script>

    <!-- Favicon and Fonts -->
    <link href="assets/img/logo.jpg" rel="icon">
    <link href="assets/img/logo.jpg" rel="apple-touch-icon">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/vendor/aos/aos.css" rel="stylesheet">
    <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
    <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

    <!-- Main CSS File -->
    <link href="assets/css/main.css" rel="stylesheet">

</head>

<body class="index-page">

    <header id="header" class="header d-flex align-items-center fixed-top">
        <div class="container-fluid container-xl position-relative d-flex align-items-center">

            <a href="index.html" class="logo d-flex align-items-center me-auto">
                <img src="assets/img/logo.jpg" alt="Logo Cursus">
                <h1 class="sitename">Cursus</h1>
            </a>

            <nav id="navmenu" class="navmenu">
                <ul>
                    <li><a href="index.html#pricing" class="active">Promoteurs à payer</a></li>
                    <li><a href="index.html#about">Tous les utilisateurs</a></li>
                    <li><a href="index.html#revenus">Calculs de revenus</a></li>
                    <li><a href="index.html#promoters-table">Paiements des Bonus d'affiliations Users</a></li>
                </ul>
                <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
            </nav>

        </div>
    </header>
    <main class="main">
        <section id="pricing" class="pricing section">
            <div class="login-container" id="loginContainer">
                <h2>Connexion Administrateur</h2>
                <form id="loginForm">
                    <div class="input-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="input-group">
                        <label for="password">Mot de passe</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <button type="submit" class="login-button">Connexion</button>
                    <p id="errorMessage" class="error-message"></p>
                </form>
            </div>
        </section>
        <section id="pricing" class="pricing section">
            <h1 id="promoterTitle" style="display: none;">Liste des Promoteurs à payer</h1>
            <div id="promoterList" class="promoter-list" style="display: none;">
                <!-- Les cartes de promoteurs seront ajoutées ici par JavaScript -->
            </div>
        </section>
        <div id="notification" class="custom-notification">
            <span id="notificationMessage"></span>
        </div>

        <!-- Popup de mise à jour du code promo -->
        <div class="popup-overlay" id="popupOverlay"></div>
        <div class="promo-popup" id="promoPopup">
            <h3>Modifier le Code Promo</h3>
            <input type="text" id="newPromoCode" placeholder="Nouveau Code Promo" required>
            <div class="popup-button-group">
                <button class="confirm-button" id="confirmPromoBtn">Confirmer</button>
                <button class="close-button" id="closePopupBtn">Fermer</button>
            </div>
        </div>
        <h1 id="about">Liste de tous les utilisateurs de Cursus Actualité</h1>

        <div class="search-container">
            <input type="text" id="searchInputField" placeholder="Rechercher un utilisateur ou promoteur..." />
        </div>
        <div id="userList" class="user-list">
            <!-- Les cartes des utilisateurs et des promoteurs seront ajoutées ici par JavaScript -->
        </div>

        <!-- Modale pour mettre à jour Questiondeverouil -->
        <div id="updateModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeModal">&times;</span>
                <h2>Mettre à jour Questiondeverouil</h2>
                <form id="updateForm">
                    <label for="questionValue">Valeur de Questiondeverouil :</label>
                    <input type="number" id="questionValue" min="1" required>
                    <input type="hidden" id="phone" />
                    <input type="hidden" id="userType" />
                    <button type="submit">Mettre à jour</button>
                </form>
            </div>
        </div>

        <!-- Alertes -->
        <div id="alert" class="alert"></div>
        <br>
        <h1 id="revenus">Calculs de revenus</h1>
        <div class="containerr">
            <!-- Card pour afficher le nombre d'utilisateurs -->
            <div class="card">
                <h2>Utilisateurs</h2>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Nombre</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Total Utilisateurs</td>
                            <td><span id="userCount" class="value">0</span></td>
                        </tr>
                        <tr>
                            <td>Utilisateurs VIP</td>
                            <td><span id="vipUserCount" class="value">0</span></td>
                        </tr>
                        <tr>
                            <td>Utilisateurs Inactifs</td>
                            <td><span id="inactiveUserCount" class="value">0</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Card pour afficher le nombre de promoteurs -->
            <div class="card">
                <h2>Promoteurs</h2>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Nombre</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Total Promoteurs</td>
                            <td><span id="promoterCount" class="value">0</span></td>
                        </tr>
                        <tr>
                            <td>Promoteurs Actifs</td>
                            <td><span id="activePromoterCount" class="value">0</span></td>
                        </tr>
                        <tr>
                            <td>Promoteurs Inactifs</td>
                            <td><span id="inactivePromoterCount" class="value">0</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Card pour afficher le total global -->
            <div class="card total">
                <h2>Total Utilisateurs + Promoteurs</h2>
                <p><span id="totalCount" class="value">0</span></p>
                <p><strong>Total Inactifs :</strong> <span id="totalInactiveCount" class="value">0</span></p>
            </div>
            <div class="chart-container">
                <canvas id="businessChart"></canvas>
            </div>

            <h1>Diagramme Circulaire</h1>
            <div class="chart-container">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
        <br>
        <h1>Paiements des Bonus d'affiliations Users</h1>
        <div class="search-container">
            <input type="text" id="Bonus" placeholder="Rechercher un userAffiliation..." />
        </div>
        <table id="promoters-table">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Affiliés</th>
                    <th>Numéro</th>
                    <th>Niveau</th>
                    <th>Bonus</th>
                    <th>Prix</th>
                    <th>Paiements</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="promoters-container">
                <!-- Les données des promoteurs seront affichées ici -->
            </tbody>
        </table>


    </main>

    <footer id="footer" class="footer position-relative light-background">

        <div class="container footer-top">
            <div class="row gy-4">
                <div class="col-lg-4 col-md-6 footer-about">
                    <a href="index.html" class="logo d-flex align-items-center">
                        <span class="sitename">Cursus</span>
                    </a>
                    <div class="footer-contact pt-3">
                        <p>Entreprise Virtuelle à Ougadougou et Bobo du Burkina Faso</p>
                        <p class="mt-3"><strong>Téléphone :</strong> <span>+226 04493510</span></p>
                        <p><strong>Email :</strong> <span>cursusbf@gmail.com</span></p>
                    </div>
                    <div class="social-links d-flex mt-4">
                        <a href=""><i class="bi bi-twitter"></i></a>
                        <a href=""><i class="bi bi-facebook"></i></a>
                        <a href=""><i class="bi bi-instagram"></i></a>
                        <a href=""><i class="bi bi-linkedin"></i></a>
                        <a href="https://wa.me/22604493510" target="_blank"><i class="bi bi-whatsapp"></i></a>
                        <!-- Lien vers WhatsApp -->
                    </div>
                </div>

                <div class="col-lg-2 col-md-3 footer-links">
                    <h4>Liens Utiles</h4>
                    <ul>
                        <li><a href="#">Accueil</a></li>
                        <li><a href="#">À Propos</a></li>
                        <li><a href="#">Services</a></li>
                        <li><a href="#">Conditions d'utilisation</a></li>
                        <li><a href="#">Politique de confidentialité</a></li>
                    </ul>
                </div>

                <div class="col-lg-2 col-md-3 footer-links">
                    <h4>Nos Services</h4>
                    <ul>
                        <li><a href="#">Préparation aux Concours</a></li>
                        <li><a href="#">Mentorat</a></li>
                        <li><a href="#">Programmes de Parrainage</a></li>
                    </ul>
                </div>

                <div class="col-lg-4 col-md-12 footer-newsletter">
                    <h4>Notre Newsletter</h4>
                    <p>Abonnez-vous à notre newsletter et recevez les dernières nouvelles sur nos produits et services !
                    </p>
                    <form action="forms/newsletter.php" method="post" class="php-email-form">
                        <div class="newsletter-form"><input type="email" name="email" placeholder="Votre Email"
                                required=""><input type="submit" value="S'abonner"></div>
                        <div class="loading">Chargement</div>
                        <div class="error-message"></div>
                        <div class="sent-message">Votre demande d'abonnement a été envoyée. Merci !</div>
                    </form>
                </div>

            </div>
        </div>


    </footer>


    <!-- Scroll Top -->
    <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i
            class="bi bi-arrow-up-short"></i></a>

    <!-- Preloader -->
    <div id="preloader"></div>

    <!-- Vendor JS Files -->
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/php-email-form/validate.js"></script>
    <script src="assets/vendor/aos/aos.js"></script>
    <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
    <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

    <!-- Main JS File -->
    <script src="assets/js/main.js"></script>

    <script>
        const user = parseInt(localStorage.getItem('user')) || 0;
        const vipUserCount = parseInt(localStorage.getItem('vipUserCount')) || 0;
        const inactiveUserCount = user - vipUserCount;  // Exemple de calcul pour les inactifs

        const promoter = parseInt(localStorage.getItem('promoter')) || 0;
        const activePromoterCount = parseInt(localStorage.getItem('activePromoterCount')) || 0;
        const inactivePromoterCount = promoter - activePromoterCount;  // Exemple de calcul pour les inactifs

        // Mise à jour des éléments sur la page
        document.getElementById('userCount').textContent = user;
        document.getElementById('vipUserCount').textContent = vipUserCount;
        document.getElementById('inactiveUserCount').textContent = inactiveUserCount;

        document.getElementById('promoterCount').textContent = promoter;
        document.getElementById('activePromoterCount').textContent = activePromoterCount;
        document.getElementById('inactivePromoterCount').textContent = inactivePromoterCount;

        // Calcul du total
        const total = user + promoter;
        document.getElementById('totalCount').textContent = total;

        // Calcul du total des inactifs
        const barChartData = {
            labels: ['Utilisateurs', 'Promoteurs'],
            datasets: [
                {
                    label: 'Actifs',
                    data: [vipUserCount + activePromoterCount, activePromoterCount],
                    backgroundColor: '#4CAF50', // green for active
                    borderColor: '#388E3C',
                    borderWidth: 1,
                },
                {
                    label: 'Inactifs',
                    data: [inactiveUserCount, inactivePromoterCount],
                    backgroundColor: '#FF7043', // red for inactive
                    borderColor: '#D32F2F',
                    borderWidth: 1,
                }
            ]
        };

        // Pie Chart Data
        const pieChartData = {
            labels: ['Utilisateurs VIP', 'Utilisateurs Non VIP', 'Promoteurs Actifs', 'Promoteurs Inactifs'],
            datasets: [{
                data: [vipUserCount, inactiveUserCount, activePromoterCount, inactivePromoterCount],
                backgroundColor: ['#4CAF50', '#FF7043', '#388E3C', '#D32F2F']
            }]
        };

        // Function to create or destroy the charts to avoid canvas reuse issues
        function createChart(chartId, chartType, data) {
            const canvas = document.getElementById(chartId);
            if (canvas.chart) {
                canvas.chart.destroy(); // Destroy the previous chart if it exists
            }

            const ctx = canvas.getContext('2d');
            canvas.chart = new Chart(ctx, {
                type: chartType,
                data: data,
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 10
                            }
                        },
                        x: {
                            ticks: {
                                fontSize: 14
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                fontSize: 14,
                            }
                        }
                    }
                }
            });
        }

        // Create Bar Chart
        createChart('businessChart', 'bar', barChartData);

        // Create Pie Chart
        createChart('statusChart', 'pie', pieChartData);

        const fetchPromoters = async () => {
            try {
                const response = await fetch('https://actualite.cursusbf.com/api/promotersbonus');

                if (!response.ok) {
                    throw new Error('Impossible de récupérer les promoteurs');
                }

                const promoters = await response.json();
                displayPromoterss(promoters);
            } catch (error) {
                console.error('Erreur lors de la récupération des promoteurs:', error);
                alert('Une erreur est survenue lors de la récupération des promoteurs.');
            }
        };
        const displayPromoterss = (promoters) => {
            const container = document.getElementById('promoters-container');
            container.innerHTML = ''; // Vider le conteneur avant de le remplir

            // Parcourir chaque promoteur pour créer une ligne dans le tableau
            promoters.forEach(promoter => {
                const { level, price, bonus, name, phone, paid, userAffiliations, payments } = promoter;

                // Logique pour déterminer si le paiement peut être effectué
                let canPay = false;
                let nextLevel = level;
                let paidLevels = payments.map(payment => payment.level); // Récupère les niveaux déjà payés

                // Logique pour le niveau 1
                if (nextLevel === 1 && userAffiliations >= 100 && !paidLevels.includes(1)) {
                    canPay = true; // Le bouton "Payer" pour le niveau 1 est activé si les affiliations >= 100 et niveau 1 non payé
                }

                // Logique pour le niveau 2
                if (nextLevel === 2) {
                    if (!paidLevels.includes(1)) {
                        canPay = true; // Niveau 1 doit être payé avant
                    } else if (paidLevels.includes(1)) {
                        canPay = false; // Niveau 2 doit être payé avant
                    }
                }
                // Logique pour le niveau 3 et suivants
                if (nextLevel === 3) {
                    if (!paidLevels.includes(1)) {
                        canPay = true; // Niveau 1 doit être payé avant
                    } else if (paidLevels.includes(1)) {
                        canPay = false; // Niveau 2 doit être payé avant
                    }
                    else if (!paidLevels.includes(2)) {
                        canPay = true; // Niveau 2 doit être payé avant
                    }
                    else if (paidLevels.includes(2)) {
                        canPay = false; // Niveau 2 doit être payé avant
                    }
                }
                if (nextLevel === 4) {
                    if (!paidLevels.includes(1)) {
                        canPay = true; // Niveau 1 doit être payé avant
                    } else if (paidLevels.includes(1)) {
                        canPay = false; // Niveau 2 doit être payé avant
                    }
                    else if (!paidLevels.includes(2)) {
                        canPay = true; // Niveau 2 doit être payé avant
                    }
                    else if (paidLevels.includes(2)) {
                        canPay = false; // Niveau 2 doit être payé avant
                    }
                    else if (!paidLevels.includes(3)) {
                        canPay = true; // Niveau 2 doit être payé avant
                    }
                    else if (paidLevels.includes(3)) {
                        canPay = false; // Niveau 2 doit être payé avant
                    }
                }
                if (nextLevel === 5) {
                    if (!paidLevels.includes(1)) {
                        canPay = true; // Niveau 1 doit être payé avant
                    } else if (paidLevels.includes(1)) {
                        canPay = false; // Niveau 2 doit être payé avant
                    }
                    else if (!paidLevels.includes(2)) {
                        canPay = true; // Niveau 2 doit être payé avant
                    }
                    else if (paidLevels.includes(2)) {
                        canPay = false; // Niveau 2 doit être payé avant
                    }
                    else if (!paidLevels.includes(3)) {
                        canPay = true; // Niveau 2 doit être payé avant
                    }
                    else if (paidLevels.includes(3)) {
                        canPay = false; // Niveau 2 doit être payé avant
                    }
                    else if (!paidLevels.includes(4)) {
                        canPay = true; // Niveau 2 doit être payé avant
                    }
                    else if (paidLevels.includes(4)) {
                        canPay = false; // Niveau 2 doit être payé avant
                    }
                }

                // Calcul du montant du paiement en fonction du niveau
                const paymentAmount = (nextLevel === 1) ? 25000 :
                    (nextLevel === 2) ? 25000 :
                        (nextLevel === 3) ? 50000 :
                            (nextLevel === 4) ? 75000 : 100000;

                // Créer une nouvelle ligne pour le promoteur
                const promoterRow = document.createElement('tr');

                // Construire le contenu HTML de la ligne
                promoterRow.innerHTML = `
            <td>${name}</td>
            <td>${userAffiliations}</td>
            <td>${phone}</td>
            <td>${level}</td>
            <td>${bonus} FCFA</td>
            <td>${price} FCFA</td>
            <td>
                ${payments.map(payment => `
                    <p>Niveau ${payment.level - 1}: ${payment.amount} FCFA payé le ${new Date(payment.date).toLocaleDateString()}</p>
                `).join('') || '<p>Aucun paiement effectué</p>'}
            </td>
            <td>
                <button class="pay-button ${paid || !canPay ? '' : 'active'}" data-phone="${phone}" ${paid || !canPay ? 'disabled' : ''}>
                    ${paid ? 'Déjà payé' : canPay ? 'Payer' : 'Non éligible'}
                </button>
            </td>
        `;

                // Ajouter un gestionnaire d'événements au bouton "Payer"
                const payButton = promoterRow.querySelector('.pay-button');
                payButton.addEventListener('click', () => {
                    if (!paidLevels.includes(1)) {
                        // Si le niveau 1 n'est pas payé, on le paye d'abord
                        payPromoter(phone, payButton, 1);
                    } else {
                        // Si le niveau 1 est payé, on peut payer le niveau actuel
                        payPromoter(phone, payButton, nextLevel);
                    }
                });

                // Ajouter la ligne au tableau
                container.appendChild(promoterRow);
            });
        };

        const payPromoter = async (phone, button, level) => {
            const paymentAmount = (level === 1) ? 25000 :
                (level === 2) ? 25000 :
                    (level === 3) ? 50000 :
                        (level === 4) ? 75000 : 100000;

            try {
                // Envoyer la requête de paiement
                const response = await fetch('https://actualite.cursusbf.com/api/update-level', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ phone, level, amount: paymentAmount }),
                });

                const data = await response.json();

                if (response.ok) {
                    // Mettre à jour l'interface : désactiver le bouton et afficher l'état du paiement
                    button.disabled = true;
                    button.innerText = `Niveau ${level} payé`;

                    // Mettre à jour l'affichage après le paiement
                    alert(`Le paiement du niveau ${level} pour ${data.promoter.name} a été effectué avec succès !`);
                    fetchPromoters(); // Recharger les données des promoteurs pour refléter les changements
                } else {
                    alert(`Erreur: ${data.message}`);
                }
            } catch (error) {
                console.error('Erreur lors de la mise à jour du paiement:', error);
                alert('Une erreur s\'est produite lors de la mise à jour du paiement.');
            }
        };
        const searchPromoters = () => {
            const searchQuery = document.getElementById('Bonus').value.toLowerCase(); // Récupère la recherche de l'utilisateur
            const rows = document.querySelectorAll('#promoters-container tr'); // Sélectionne toutes les lignes du tableau

            rows.forEach(row => {
                const name = row.querySelector('td:nth-child(1)').textContent.toLowerCase(); // Nom du promoteur
                const phone = row.querySelector('td:nth-child(3)').textContent.toLowerCase(); // Numéro de téléphone

                // Si le nom ou le numéro de téléphone correspond à la recherche, affiche la ligne, sinon la cache
                if (name.includes(searchQuery) || phone.includes(searchQuery)) {
                    row.style.display = ''; // Afficher la ligne
                } else {
                    row.style.display = 'none'; // Cacher la ligne
                }
            });
        };

        // Attacher l'événement de recherche au champ de texte
        document.getElementById('Bonus').addEventListener('input', searchPromoters);
        // Initialisation de la page
        fetchPromoters();
        async function fetchUsersAndPromoters() {
            try {
                const response = await fetch('https://actualite.cursusbf.com/api/users-and-promoters');
                const data = await response.json();
                const userList = document.getElementById('userList');
                const alert = document.getElementById('alert');

                // Vider la liste avant de la remplir
                userList.innerHTML = '';
                localStorage.setItem('user', data.userCount);
                localStorage.setItem('vipUserCount', data.vipUserCount);
                localStorage.setItem('promoter', data.promoterCount);
                localStorage.setItem('activePromoterCount', data.activePromoterCount);
                // Afficher les utilisateurs
                data.users.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.classList.add('user-card');
                    userCard.classList.add('user-item'); // Ajout d'une classe pour la recherche
                    userCard.innerHTML = `
                    <p>Nom: ${user.name}</p>
                    <p>Téléphone: ${user.phone}</p>
                    <p>Question de verrouillage: ${user.Questiondeverouil}</p>
                    <button onclick="openModal('${user.phone}', 'user', ${user.Questiondeverouil})">Mettre à jour</button>
                `;
                    userList.appendChild(userCard);
                });

                // Afficher les promoteurs
                data.promoters.forEach(promoter => {
                    const promoterCard = document.createElement('div');
                    promoterCard.classList.add('user-card');
                    promoterCard.classList.add('user-item'); // Ajout d'une classe pour la recherche
                    promoterCard.innerHTML = `
                    <p>Nom: ${promoter.name}</p>
                    <p>Téléphone: ${promoter.phone}</p>
                    <p>Question de verrouillage: ${promoter.Questiondeverouil}</p>
                    <button onclick="openModal('${promoter.phone}', 'promoter', ${promoter.Questiondeverouil})">Mettre à jour</button>
                `;
                    userList.appendChild(promoterCard);
                });

                // Affichage des alertes
                if (data.userCount === 0 && data.promoterCount === 0) {
                    showAlert('Aucun utilisateur ou promoteur trouvé.');
                }
            } catch (error) {
                console.error('Erreur de récupération des données:', error);
                showAlert('Une erreur est survenue lors de la récupération des données.');
            }
        }
        document.getElementById('searchInputField').addEventListener('input', function (event) {
            const query = event.target.value.toLowerCase();
            const items = document.querySelectorAll('.user-item');

            items.forEach(item => {
                const name = item.querySelector('p:nth-child(1)').textContent.toLowerCase();
                const phone = item.querySelector('p:nth-child(2)').textContent.toLowerCase();
                if (name.includes(query) || phone.includes(query)) {
                    item.style.display = 'block';  // Afficher l'élément si la recherche correspond
                } else {
                    item.style.display = 'none';  // Cacher l'élément sinon
                }
            });
        });

        // Ouvrir la modale pour la mise à jour de Questiondeverouil
        function openModal(phone, userType, currentValue) {
            document.getElementById('phone').value = phone;
            document.getElementById('userType').value = userType;
            document.getElementById('questionValue').value = currentValue;
            document.getElementById('updateModal').style.display = 'block';
        }

        // Fermer la modale
        document.getElementById('closeModal').onclick = function () {
            document.getElementById('updateModal').style.display = 'none';
        };

        // Afficher les alertes
        function showAlert(message) {
            const alertBox = document.getElementById('alert');
            alertBox.textContent = message;
            alertBox.style.display = 'block';
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 3000);
        }

        // Mettre à jour Questiondeverouil
        document.getElementById('updateForm').onsubmit = async function (event) {
            event.preventDefault();

            const phone = document.getElementById('phone').value;
            const userType = document.getElementById('userType').value;
            const questionValue = document.getElementById('questionValue').value;

            try {
                const response = await fetch('https://actualite.cursusbf.com/api/update-question-deverouil', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone,
                        userType,
                        questiondeverouil: parseInt(questionValue)
                    })
                });

                const data = await response.json();
                if (response.status === 200) {
                    showNotification('Questiondeverouil mis à jour avec succès.');
                    fetchUsersAndPromoters();  // Recharger la liste après la mise à jour
                    document.getElementById('updateModal').style.display = 'none';
                } else {
                    showNotification(data.message);
                }
            } catch (error) {
                console.error('Erreur de mise à jour:', error);
                showNotification('Une erreur est survenue lors de la mise à jour.');
            }
        };

        // Charger les données au démarrage
        fetchUsersAndPromoters();
        document.addEventListener('DOMContentLoaded', () => {
            // Vérifier si la connexion a déjà été enregistrée dans le localStorage
            const isLoggedIn = localStorage.getItem('isLoggedIn');

            // Si l'utilisateur est déjà connecté, charger directement les promoteurs
            if (isLoggedIn) {
                fetchAndDisplayPromoters();
            } else {
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('promotersListContainer').style.display = 'none';
            }
        });

        document.getElementById('loginForm').addEventListener('submit', async function (event) {
            event.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');

            try {
                const response = await fetch('https://actualite.cursusbf.com/api/admin-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();

                if (response.ok) {
                    // Enregistrer l'état de la connexion dans le localStorage
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('email', email);
                    localStorage.setItem('password', password);
                    // Afficher les promoteurs ayant un totalEarnings > 0
                    const promoters = result.promoters.filter(promoter => promoter.totalEarnings > 0);
                    displayPromoters(promoters);
                } else {
                    errorMessage.textContent = result.message;
                }
            } catch (error) {
                console.error('Erreur lors de la connexion:', error);
                errorMessage.textContent = 'Erreur de connexion. Veuillez réessayer.';
            }
        });

        function displayPromoters(promoters) {
            const promotersListContainer = document.getElementById('promotersList');
            promotersListContainer.style.display = 'block';

            const list = document.createElement('ul');
            promoters.forEach(promoter => {
                const listItem = document.createElement('li');
                listItem.textContent = `${promoter.name}: ${promoter.totalEarnings}`;
                list.appendChild(listItem);
            });

            promotersListContainer.innerHTML = '';
            promotersListContainer.appendChild(list);

            // Masquer le formulaire de connexion
            document.getElementById('loginContainer').style.display = 'none';
        }
        function editPromoCode(promoterId, currentPromoCode) {
            currentPromoterId = promoterId;
            document.getElementById('newPromoCode').value = currentPromoCode; // Remplir le champ avec l'actuel code promo
            document.getElementById('popupOverlay').style.display = 'block';
            document.getElementById('promoPopup').style.display = 'block';
        }

        // Fonction pour fermer le popup
        document.getElementById('closePopupBtn').addEventListener('click', function () {
            document.getElementById('popupOverlay').style.display = 'none';
            document.getElementById('promoPopup').style.display = 'none';
        });

        // Fonction pour confirmer la mise à jour du code promo
        document.getElementById('confirmPromoBtn').addEventListener('click', async function () {
            const newPromoCode = document.getElementById('newPromoCode').value;
            if (!newPromoCode) {
                showNotification('Le code promo ne peut pas être vide.', true); // Notification d'erreur
                return;
            }

            try {
                const email = localStorage.getItem('email');
                const password = localStorage.getItem('password');
                const response = await fetch(`https://actualite.cursusbf.com/api/admin-login/update-promoCode`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        promoterId: currentPromoterId,
                        promoCode: newPromoCode
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    showNotification('Code promo mis à jour avec succès!'); // Notification de succès
                    window.location.reload();
                    // Mettre à jour la carte sans recharger la page
                    const card = document.querySelector(`[onclick="editPromoCode('${currentPromoterId}')"]`).parentElement;
                    card.querySelector('p').textContent = `Code promo: ${newPromoCode} `;

                } else {
                    showNotification(result.message, true); // Notification d'erreur
                }
            } catch (error) {
                showNotification('Veuillez actualiser la page et vérifier si les modifications ont été prises en charge.'); // Notification d'erreur
                window.location.reload();
            }

            // Fermer le popup
            document.getElementById('popupOverlay').style.display = 'none';
            document.getElementById('promoPopup').style.display = 'none';
        });

        async function fetchAndDisplayPromoters() {
            try {
                const email = localStorage.getItem('email');
                const password = localStorage.getItem('password');
                const response = await fetch('https://actualite.cursusbf.com/api/admin-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();

                if (response.ok) {
                    const promoters = result.promoters.filter(promoter => (promoter.pendingUserAffiliations + promoter.pendingPromoterAffiliations) > 0);
                    displayPromoters(promoters);
                } else {
                    console.error('Erreur lors de la récupération des promoteurs:', result.message);
                }
            } catch (error) {
                console.error('Erreur lors de la récupération des promoteurs:', error);
            }
        }

        // Fonction pour afficher la liste des promoteurs après connexion réussie
        function displayPromoters(promoters) {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('promoterTitle').style.display = 'block';
            document.getElementById('promoterList').style.display = 'flex';

            const promoterList = document.getElementById('promoterList');
            promoterList.innerHTML = '';  // Vider la liste au cas où

            // Générer les cartes de promoteur
            promoters.forEach(promoter => {
                // Calcul du total des gains
                const totalEarnings = (promoter.pendingUserAffiliations * 500) + (promoter.pendingPromoterAffiliations *1000);

                // Vérification si le total est inférieur à 0
                const isNegative = totalEarnings < 0;

                const card = document.createElement('div');
                card.className = 'promoter-card';

                card.innerHTML = `
                    <h3>${promoter.name}</h3>
                    <p>Numéro: ${promoter.phone}</p> 
                    <p>Total des gains: ${(promoter.pendingUserAffiliations * 500) + (promoter.pendingPromoterAffiliations *1000)} FCFA</p>
                    <p>Code promo: ${promoter.promoCode} <i class="fas fa-edit promo-icon" onclick="editPromoCode('${promoter._id}', '${promoter.promoCode}')"></i></p>
                    <div class="button-group">
                        <button class="validate-button" onclick="validatePromoter('${promoter._id}')">Valider</button>
                        <button class="cancel-button" onclick="cancelPromoter('${promoter._id}')">Annuler</button>
                    </div>
                `;

                // Si le total des gains est négatif, ajouter une classe ou un message d'avertissement
                if (isNegative) {
                    card.classList.add('negative-earnings'); // Assurez-vous de définir cette classe dans votre CSS
                    // Ajouter un message d'avertissement
                    const warning = document.createElement('p');
                    warning.className = 'warning-message';
                    warning.textContent = 'Attention : Les gains totaux sont inférieurs à 0.';
                    card.appendChild(warning);
                }

                promoterList.appendChild(card);
            });
        }

        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notificationMessage');

            notificationMessage.textContent = message;
            notification.classList.toggle('error-notification', isError); // Ajouter une classe d'erreur si besoin
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000); // Masquer la notification après 4 secondes
        }
        // Fonction pour valider un promoteur
        async function validatePromoter(promoterId) {
            try {
                const response = await fetch(`https://actualite.cursusbf.com/api/reward/validate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ promoterId })
                });
                if (response.ok) {
                    showNotification('Promoteur validé avec succès !');
                    window.location.reload();
                } else {
                    const result = await response.json();
                    showNotification(result.message);
                }
            } catch (error) {
                console.error('Erreur lors de la validation:', error);
                // showNotification('Erreur lors de la validation. Veuillez réessayer.');
            }
        }

        // Fonction pour annuler un promoteur
        async function cancelPromoter(promoterId) {
            try {
                const response = await fetch(`https://actualite.cursusbf.com/api/reward/cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ promoterId })
                });
                if (response.ok) {
                    showNotification("Promoteur annulé avec succès !");
                } else {
                    const result = await response.json();
                    showNotification(result.message);
                }
            } catch (error) {
                console.error('Erreur lors de l\'annulation:', error);
                showNotification('Erreur lors de l\'annulation. Veuillez réessayer.', true);
            }
        }
    </script>
</body>

</html>
<style>
    .containerr {
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        width: 80%;
        max-width: 800px;
        margin: 0 auto;
        text-align: center;
        color: #0056b3;
    }

    #promoters-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    #promoters-table th,
    #promoters-table td {
        padding: 10px;
        text-align: center;
        border: 1px solid #ddd;
    }

    #promoters-table th {
        background-color: #f4f4f4;
        font-weight: bold;
    }

    #promoters-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    #promoters-table tr:hover {
        background-color: #f1f1f1;
    }

    .pay-button {
        padding: 8px 16px;
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .pay-button:hover {
        background-color: #45a049;
    }

    .pay-button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    /* Style pour les cartes */
    .card {
        color: #0056b3;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
        margin-top: 20px;
    }

    .total {
        background-color: #4CAF50;
        color: white;
        font-weight: bold;
    }

    .card h2 {
        color: #333;
        font-size: 24px;
        margin-bottom: 15px;
    }

    /* Style pour les tableaux */
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .data-table th,
    .data-table td {
        padding: 12px;
        text-align: center;
        border: 1px solid #ddd;
    }

    .data-table th {
        background-color: #4CAF50;
        color: white;
        font-weight: bold;
    }

    .data-table td {
        background-color: #7191cc;
    }

    .data-table tbody tr:hover {
        background-color: #f1f1f1;
    }

    .value {
        font-size: 22px;
        color: #333;
        font-weight: bold;
    }

    /* Amélioration pour la card totale */
    .total .value {
        font-size: 36px;
    }

    /* Améliorations visuelles pour les titres */
    .card h2 {
        font-size: 1.2em;
        margin-bottom: 10px;
        font-weight: 600;
    }

    .card li {
        font-size: 1em;
        font-weight: normal;
    }

    .value {
        font-size: 1.8em;
        color: #fff;
        font-weight: 700;
    }

    .search-container {
        text-align: center;
        margin-bottom: 20px;
    }

    #Bonus {
        width: 80%;
        max-width: 500px;
        padding: 12px;
        font-size: 1em;
        border-radius: 5px;
        border: 1px solid #ddd;
        margin-bottom: 20px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        transition: width 0.3s ease;
    }

    #Bonus:focus {
        width: 90%;
        border-color: #007bff;
        outline: none;
    }

    #searchInputField {
        width: 80%;
        max-width: 500px;
        padding: 12px;
        font-size: 1em;
        border-radius: 5px;
        border: 1px solid #ddd;
        margin-bottom: 20px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        transition: width 0.3s ease;
    }

    #searchInputField:focus {
        width: 90%;
        border-color: #007bff;
        outline: none;
    }

    /* Style pour mettre en surbrillance les occurrences */
    .highlight {
        background-color: yellow;
        color: yellow;
        padding: 0 3px;
        border-radius: 3px;
    }

    .login-container {
        background-color: #fff;
        padding: 2em;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        width: 300px;
        margin-top: 2em;
    }

    .input-group {
        margin-bottom: 1em;
        text-align: left;
    }

    .input-group label {
        display: block;
        font-size: 0.9em;
        margin-bottom: 0.3em;
        color: #333;
    }

    .input-group input {
        width: 100%;
        padding: 0.7em;
        font-size: 1em;
        border: 1px solid #ddd;
        border-radius: 4px;
        transition: all 0.3s;
    }

    .login-button {
        width: 100%;
        padding: 0.8em;
        font-size: 1em;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
        margin-top: 20px;
    }

    .promoter-list {
        display: flex;
        flex-direction: column;
        gap: 1em;
        align-items: center;
        margin-top: 2em;
    }

    .promoter-card {
        background-color: #fff;
        width: 100%;
        max-width: 400px;
        padding: 1.5em;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        text-align: left;
    }

    .button-group {
        display: flex;
        gap: 1em;
    }

    .validate-button,
    .cancel-button {
        flex: 1;
        padding: 0.7em;
        font-size: 1em;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .validate-button {
        background-color: #28a745;
        color: #fff;
    }

    .cancel-button {
        background-color: #dc3545;
        color: #fff;
    }

    .error-message {
        color: red;
        font-size: 0.9em;
        margin-top: 0.5em;
    }

    /* Title */
    h1 {
        text-align: center;
        font-size: 2em;
        color: #333;
        margin-bottom: 1.5em;
        font-weight: 600;
    }

    /* User and Promoter List */
    .user-list {
        display: flex;
        flex-wrap: wrap;
        gap: 2em;
        justify-content: center;
        margin: 0 2em;
    }

    /* User/Promoter Card */
    .user-card {
        background-color: #fff;
        width: 100%;
        max-width: 350px;
        padding: 1.5em;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        text-align: left;
        transition: box-shadow 0.3s ease-in-out;
    }

    .user-card:hover {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    .user-card p {
        margin: 0.5em 0;
        color: #555;
        font-size: 1em;
    }

    .user-card button {
        padding: 0.8em;
        font-size: 1em;
        color: white;
        background-color: #007bff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        width: 100%;
        margin-top: 1em;
    }

    .user-card button:hover {
        background-color: #0056b3;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 80px;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
        justify-content: center;
        align-items: center;
        padding: 2em;
    }

    .modal-content {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        width: 300px;
        max-width: 90%;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .modal h2 {
        font-size: 1.5em;
        color: #333;
        margin-bottom: 1em;
    }

    .close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 30px;
        color: #aaa;
        cursor: pointer;
    }

    /* Alert Box */
    .alert {
        position: fixed;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        padding: 15px;
        background-color: #f44336;
        color: white;
        border-radius: 8px;
        display: none;
        font-size: 1.2em;
        max-width: 90%;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    /* Form Inputs */
    input[type="number"] {
        width: 100%;
        padding: 0.8em;
        font-size: 1em;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-bottom: 1em;
        color: #333;
    }

    button[type="submit"] {
        width: 100%;
        padding: 1em;
        font-size: 1.2em;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    button[type="submit"]:hover {
        background-color: #218838;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .user-list {
            flex-direction: column;
            align-items: center;
        }

        .user-card {
            width: 90%;
        }
    }

    .promo-icon {
        cursor: pointer;
        color: #007bff;
        font-size: 1.5em;
        margin-top: 1em;
    }

    .promo-popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 2em;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        width: 300px;
        z-index: 1000;
    }

    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 999;
    }

    .popup-button-group {
        display: flex;
        gap: 1em;
        margin-top: 1em;
    }

    .custom-notification {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #28a745;
        /* Vert pour le succès */
        color: white;
        padding: 1em 2em;
        border-radius: 5px;
        font-size: 1em;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: none;
        /* Masquée par défaut */
        z-index: 9999;
        animation: fadeIn 0.5s ease-out;
    }

    /* Animation de fade-in */
    @keyframes fadeIn {
        from {
            opacity: 0;
            top: 10px;
        }

        to {
            opacity: 1;
            top: 20px;
        }
    }

    .error-notification {
        background-color: #dc3545;
        /* Rouge pour l'erreur */
    }

    .confirm-button,
    .close-button {
        flex: 1;
        padding: 0.7em;
        font-size: 1em;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .confirm-button {
        background-color: #28a745;
        color: #fff;
    }

    .close-button {
        background-color: #dc3545;
        color: #fff;
    }

    @media (max-width: 768px) {
        .promoter-list {
            flex-direction: column;
            align-items: stretch;
        }

        .promoter-card {
            width: 90%;
            max-width: 100%;
            margin-bottom: 1em;
        }
    }

    @media (max-width: 768px) {

        /* Conteneur principal */
        .containerr {
            width: 95%;
            padding: 15px;
        }

        /* Tableaux */
        #promoters-table,
        .data-table {
            font-size: 0.9em;
        }

        /* Boutons */
        .pay-button,
        .validate-button,
        .cancel-button {
            padding: 10px;
            font-size: 1em;
        }

        /* Cartes */
        .card,
        .user-card {
            width: 90%;
            padding: 15px;
        }

        .user-list {
            flex-direction: column;
            align-items: center;
            gap: 1.5em;
        }

        /* Champs de saisie */
        #Bonus,
        #searchInputField,
        input[type="number"] {
            width: 90%;
            padding: 14px;
            font-size: 0.9em;
        }

        /* Notifications */
        .custom-notification {
            padding: 0.8em 1.5em;
            font-size: 1em;
        }

        /* Modals */
        .modal-content {
            width: 80%;
            padding: 1.5em;
        }

        /* Focus des champs */
        #Bonus:focus,
        #searchInputField:focus {
            border-color: #007bff;
        }

        .promo-icon {
            font-size: 1.3em;
        }

        .modal {
            padding: 1em;
        }

        /* Title */
        h1 {
            font-size: 1.8em;
        }

        /* Liste utilisateurs/promoteurs */
        .promoter-list {
            flex-direction: column;
            gap: 1em;
        }

        .user-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
    }
</style>
